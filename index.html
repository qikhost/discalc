<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retail POS</title>
<meta name="theme-color" content="#0f172a">

<style>
body {
  margin:0; font-family:system-ui; background:#0f172a; color:#fff;
}
.app {
  max-width:520px; margin:auto; padding:16px;
}
h1 { text-align:center; }
input, select, button {
  width:100%; padding:14px; margin-top:6px;
  border-radius:10px; border:none; font-size:1rem;
}
button {
  background:#22c55e; color:#000; font-weight:bold;
}
.item {
  background:#020617; padding:12px; margin-top:10px; border-radius:10px;
}
.total {
  font-size:1.4rem; color:#22c55e; font-weight:bold;
}
.row {
  display:flex; justify-content:space-between; margin-top:6px;
}
hr { border-color:#1f2937; }
</style>
</head>

<body>
<div class="app">
<h1>Retail POS</h1>

<label>ZIP Code</label>
<input id="zip" inputmode="numeric" placeholder="90210">

<label>Payment Type</label>
<select id="payment">
  <option value="card">Card</option>
  <option value="cash">Cash (round to $0.05)</option>
</select>

<hr>

<div id="items"></div>
<button onclick="addItem()">+ Add Item</button>

<hr>

<div class="row"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
<div class="row"><span>Tax</span><span id="tax">$0.00</span></div>
<div class="row total"><span>Total</span><span id="total">$0.00</span></div>
</div>

<script>
/* =======================
   STATE
======================= */
let items = [];
let taxRate = 0;

/* =======================
   ZIP â†’ TAX (cached)
======================= */
async function fetchTax(zip) {
  if (!zip) return;
  if (localStorage["tax_"+zip]) {
    taxRate = parseFloat(localStorage["tax_"+zip]);
    calc();
    return;
  }

  try {
    const res = await fetch("https://api.zippopotam.us/us/" + zip);
    if (!res.ok) return;
    const data = await res.json();
    const state = data.places[0]["state abbreviation"];

    const stateRates = {
      CA:.0725, TX:.0625, NY:.04, FL:.06, IL:.0625,
      PA:.06, OH:.0575, GA:.04, NC:.0475
    };

    taxRate = stateRates[state] ?? 0.05;
    localStorage["tax_"+zip] = taxRate;
    calc();
  } catch {
    taxRate = 0;
  }
}

document.getElementById("zip").addEventListener("change", e => {
  fetchTax(e.target.value);
});

/* =======================
   ITEMS
======================= */
function addItem() {
  items.push({ price:0, discount:0 });
  render();
}

function render() {
  const el = document.getElementById("items");
  el.innerHTML = "";
  items.forEach((item, i) => {
    el.innerHTML += `
      <div class="item">
        <label>Price</label>
        <input type="number" step="0.01" value="${item.price}"
          oninput="items[${i}].price=this.value;calc()">

        <label>Discount %</label>
        <input type="number" step="0.01" value="${item.discount}"
          oninput="items[${i}].discount=this.value;calc()">

        <button onclick="items.splice(${i},1);render();calc()">Remove</button>
      </div>`;
  });
}

/* =======================
   ROUNDING
======================= */
function roundCash(val) {
  return Math.round(val / 0.05) * 0.05;
}

/* =======================
   CALCULATION
======================= */
function calc() {
  let subtotal = 0;
  items.forEach(i => {
    subtotal += i.price * (1 - i.discount / 100);
  });

  let tax = subtotal * taxRate;
  let total = subtotal + tax;

  if (document.getElementById("payment").value === "cash") {
    total = roundCash(total);
  }

  document.getElementById("subtotal").textContent = "$" + subtotal.toFixed(2);
  document.getElementById("tax").textContent = "$" + tax.toFixed(2);
  document.getElementById("total").textContent = "$" + total.toFixed(2);
}

/* =======================
   PWA (INLINE)
======================= */
if ("serviceWorker" in navigator) {
  const swCode = `
    self.addEventListener("install", e => {
      e.waitUntil(
        caches.open("pos").then(c => c.addAll(["./"]))
      );
    });
    self.addEventListener("fetch", e => {
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request))
      );
    });
  `;
  const blob = new Blob([swCode], {type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

// Manifest injection
const manifest = {
  name: "Retail POS",
  short_name: "POS",
  start_url: ".",
  display: "standalone",
  background_color: "#0f172a",
  theme_color: "#0f172a"
};
const manifestBlob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
const manifestURL = URL.createObjectURL(manifestBlob);
const link = document.createElement("link");
link.rel = "manifest";
link.href = manifestURL;
document.head.appendChild(link);

/* INIT */
addItem();
</script>
</body>
</html>
