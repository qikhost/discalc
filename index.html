<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discount Calculator</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f172a;
  color: #f9fafb;
}
.app {
  max-width: 520px;
  margin: auto;
  padding: 16px;
}
h1 {
  text-align: center;
  margin-bottom: 12px;
}
label {
  font-size: 0.85rem;
  color: #9ca3af;
}
input, select, button {
  width: 100%;
  padding: 14px;
  margin-top: 6px;
  border-radius: 10px;
  border: none;
  font-size: 1rem;
}
button {
  background: #22c55e;
  color: #020617;
  font-weight: bold;
}
hr {
  border: none;
  border-top: 1px solid #1f2937;
  margin: 14px 0;
}
.item {
  background: #020617;
  padding: 12px;
  border-radius: 12px;
  margin-top: 10px;
}
.row {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
}
.total {
  font-size: 1.4rem;
  font-weight: bold;
  color: #22c55e;
}
</style>
</head>

<body>
<div class="app">
<h1>Discount Calculator</h1>

<label>ZIP Code (auto tax)</label>
<input id="zip" inputmode="numeric" placeholder="90210">

<label>Payment Type</label>
<select id="payment">
  <option value="card">Card (standard rounding)</option>
  <option value="cash">Cash (round to $0.05)</option>
</select>

<hr>

<div id="items"></div>
<button onclick="addItem()">+ Add Item</button>

<hr>

<div class="row"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
<div class="row"><span>Tax</span><span id="tax">$0.00</span></div>
<div class="row total"><span>Total</span><span id="total">$0.00</span></div>
</div>

<script>
/* ======================
   STATE
====================== */
let items = [];
let taxRate = 0;

/* ======================
   ZIP â†’ TAX (cached)
====================== */
async function fetchTax(zip) {
  if (!zip) return;

  const cacheKey = "tax_" + zip;
  if (localStorage[cacheKey]) {
    taxRate = parseFloat(localStorage[cacheKey]);
    calc();
    return;
  }

  try {
    const res = await fetch("https://api.zippopotam.us/us/" + zip);
    if (!res.ok) throw new Error();
    const data = await res.json();
    const state = data.places[0]["state abbreviation"];

    const stateRates = {
      AL:0.04, AZ:0.056, CA:0.0725, CO:0.029, FL:0.06,
      GA:0.04, IL:0.0625, NY:0.04, PA:0.06, TX:0.0625,
      WA:0.065
    };

    taxRate = stateRates[state] ?? 0.05;
    localStorage[cacheKey] = taxRate;
    calc();
  } catch {
    taxRate = 0;
    calc();
  }
}

document.getElementById("zip").addEventListener("change", e => {
  fetchTax(e.target.value);
});

/* ======================
   ITEMS
====================== */
function addItem() {
  items.push({ price: 0, discount: 0 });
  renderItems();
}

function renderItems() {
  const container = document.getElementById("items");
  container.innerHTML = "";

  items.forEach((item, index) => {
    container.innerHTML += `
      <div class="item">
        <label>Item Price</label>
        <input type="number" step="0.01" min="0"
          value="${item.price}"
          oninput="items[${index}].price=this.value;calc()">

        <label>Discount (%)</label>
        <input type="number" step="0.01" min="0" max="95"
          value="${item.discount}"
          oninput="items[${index}].discount=this.value;calc()">

        <button onclick="items.splice(${index},1);renderItems();calc()">
          Remove Item
        </button>
      </div>
    `;
  });
}

/* ======================
   ROUNDING RULES
====================== */
function roundCash(value) {
  return Math.round(value / 0.05) * 0.05;
}

/* ======================
   CALCULATIONS
====================== */
function calc() {
  let subtotal = 0;

  items.forEach(item => {
    subtotal += item.price * (1 - item.discount / 100);
  });

  let tax = subtotal * taxRate;
  let total = subtotal + tax;

  if (document.getElementById("payment").value === "cash") {
    total = roundCash(total);
  }

  document.getElementById("subtotal").textContent = `$${subtotal.toFixed(2)}`;
  document.getElementById("tax").textContent = `$${tax.toFixed(2)}`;
  document.getElementById("total").textContent = `$${total.toFixed(2)}`;
}

/* ======================
   INIT
====================== */
addItem();
</script>
</body>
</html>
